import React, { useState } from 'react';
import { useTodos } from '../hooks/useTodos';
import { AddTodoForm } from '../components/features/AddTodoForm';
import { TodoList } from '../components/features/TodoList';
import { CategoryManager } from '../components/features/CategoryManager';
import { AdvancedSearchBar } from '../components/features/AdvancedSearchBar';
import { FilterPresets } from '../components/features/FilterPresets';
import { getDueDateCategory } from '../utils/dateUtils';

export const TodoPage: React.FC = () => {
  const { 
    todos, 
    categories, 
    createTodo, 
    updateTodo,
    toggleComplete, 
    deleteTodo, 
    updatePriority,
    filters, 
    setFilters, 
    getCategoryById,
    createCategory,
    updateCategory,
    deleteCategory 
  } = useTodos();
  const [editingId, setEditingId] = useState<string | null>(null);

  const handleEdit = (id: string) => {
    setEditingId(id);
  };

  const handleCancelEdit = () => {
    setEditingId(null);
  };

  const handleFiltersChange = (newFilters: typeof filters) => {
    setFilters(newFilters);
  };

  const handleStatusFilter = (status: 'all' | 'active' | 'completed') => {
    setFilters({ ...filters, status });
  };

  const handlePriorityFilter = (priority: 'low' | 'medium' | 'high' | undefined) => {
    setFilters({ ...filters, priority });
  };

  const handleCategoryFilter = (category: string | undefined) => {
    setFilters({ ...filters, category });
  };

  const handleDueDateFilter = (dueDate: 'all' | 'overdue' | 'today' | 'tomorrow' | 'thisWeek' | 'thisMonth' | 'future' | 'noDueDate') => {
    setFilters({ ...filters, dueDate });
  };

  const completedCount = todos.filter(todo => todo.completed).length;
  const activeCount = todos.filter(todo => !todo.completed).length;

  // ÎßàÍ∞êÏùº Í¥ÄÎ†® ÌÜµÍ≥Ñ Í≥ÑÏÇ∞
  const overdueCount = todos.filter(todo => !todo.completed && getDueDateCategory(todo.dueDate) === 'overdue').length;
  const todayCount = todos.filter(todo => !todo.completed && getDueDateCategory(todo.dueDate) === 'today').length;

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div className="mb-8">
          <div className="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-5">
            <div className="bg-white overflow-hidden shadow rounded-lg">
              <div className="p-5">
                <div className="flex items-center">
                  <div className="flex-shrink-0">
                    <div className="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                      <span className="text-white font-medium">üìä</span>
                    </div>
                  </div>
                  <div className="ml-5 w-0 flex-1">
                    <dl>
                      <dt className="text-sm font-medium text-gray-500 truncate">Ï†ÑÏ≤¥ Ìï† Ïùº</dt>
                      <dd className="text-3xl font-semibold text-gray-900">{todos.length}</dd>
                    </dl>
                  </div>
                </div>
              </div>
            </div>
            
            <div className="bg-white overflow-hidden shadow rounded-lg">
              <div className="p-5">
                <div className="flex items-center">
                  <div className="flex-shrink-0">
                    <div className="w-8 h-8 bg-orange-500 rounded-md flex items-center justify-center">
                      <span className="text-white font-medium">‚è≥</span>
                    </div>
                  </div>
                  <div className="ml-5 w-0 flex-1">
                    <dl>
                      <dt className="text-sm font-medium text-gray-500 truncate">ÏßÑÌñâ Ï§ë</dt>
                      <dd className="text-3xl font-semibold text-gray-900">{activeCount}</dd>
                    </dl>
                  </div>
                </div>
              </div>
            </div>
            
            <div className="bg-white overflow-hidden shadow rounded-lg">
              <div className="p-5">
                <div className="flex items-center">
                  <div className="flex-shrink-0">
                    <div className="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                      <span className="text-white font-medium">‚úÖ</span>
                    </div>
                  </div>
                  <div className="ml-5 w-0 flex-1">
                    <dl>
                      <dt className="text-sm font-medium text-gray-500 truncate">ÏôÑÎ£å</dt>
                      <dd className="text-3xl font-semibold text-gray-900">{completedCount}</dd>
                    </dl>
                  </div>
                </div>
              </div>
            </div>

            <div className="bg-white overflow-hidden shadow rounded-lg">
              <div className="p-5">
                <div className="flex items-center">
                  <div className="flex-shrink-0">
                    <div className="w-8 h-8 bg-red-500 rounded-md flex items-center justify-center">
                      <span className="text-white font-medium">‚ö†Ô∏è</span>
                    </div>
                  </div>
                  <div className="ml-5 w-0 flex-1">
                    <dl>
                      <dt className="text-sm font-medium text-gray-500 truncate">ÏßÄÏó∞</dt>
                      <dd className="text-3xl font-semibold text-gray-900">{overdueCount}</dd>
                    </dl>
                  </div>
                </div>
              </div>
            </div>

            <div className="bg-white overflow-hidden shadow rounded-lg">
              <div className="p-5">
                <div className="flex items-center">
                  <div className="flex-shrink-0">
                    <div className="w-8 h-8 bg-yellow-500 rounded-md flex items-center justify-center">
                      <span className="text-white font-medium">üìÖ</span>
                    </div>
                  </div>
                  <div className="ml-5 w-0 flex-1">
                    <dl>
                      <dt className="text-sm font-medium text-gray-500 truncate">Ïò§Îäò</dt>
                      <dd className="text-3xl font-semibold text-gray-900">{todayCount}</dd>
                    </dl>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      <CategoryManager
        categories={categories}
        onCreateCategory={createCategory}
        onUpdateCategory={updateCategory}
        onDeleteCategory={deleteCategory}
      />

      <AddTodoForm onAddTodo={createTodo} categories={categories} />

        <div className="mb-8">
          <div className="bg-white shadow rounded-lg">
            <div className="px-4 py-5 sm:p-6">
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div className="lg:col-span-2">
                  <label htmlFor="search" className="block text-sm font-medium text-gray-700 mb-2">Í≤ÄÏÉâ</label>
                  <AdvancedSearchBar
                    filters={filters}
                    onFiltersChange={handleFiltersChange}
                  />
                </div>
                
                <div className="flex space-x-3">
                  <div className="flex-1">
                    <label htmlFor="status" className="block text-sm font-medium text-gray-700">ÏÉÅÌÉú</label>
                    <select
                      id="status"
                      value={filters.status}
                      onChange={(e) => handleStatusFilter(e.target.value as 'all' | 'active' | 'completed')}
                      className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md"
                    >
                      <option value="all">Ï†ÑÏ≤¥</option>
                      <option value="active">ÏßÑÌñâ Ï§ë</option>
                      <option value="completed">ÏôÑÎ£å</option>
                    </select>
                  </div>
                </div>
              </div>
              
              <div className="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div>
                  <label htmlFor="category" className="block text-sm font-medium text-gray-700">Ïπ¥ÌÖåÍ≥†Î¶¨</label>
                  <div className="mt-1 flex flex-wrap gap-2">
                    <button
                      onClick={() => handleCategoryFilter(undefined)}
                      className={`inline-flex items-center px-3 py-2 rounded-md text-sm font-medium border ${
                        !filters.category 
                          ? 'bg-blue-100 border-blue-300 text-blue-700' 
                          : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50'
                      }`}
                    >
                      Ï†ÑÏ≤¥
                    </button>
                    {categories.map((category) => {
                      const isSelected = filters.category === category.id;
                      const colorClasses = {
                        blue: isSelected ? 'bg-blue-500 text-white border-blue-500' : 'bg-blue-100 text-blue-700 border-blue-300 hover:bg-blue-200',
                        green: isSelected ? 'bg-green-500 text-white border-green-500' : 'bg-green-100 text-green-700 border-green-300 hover:bg-green-200',
                        purple: isSelected ? 'bg-purple-500 text-white border-purple-500' : 'bg-purple-100 text-purple-700 border-purple-300 hover:bg-purple-200',
                        orange: isSelected ? 'bg-orange-500 text-white border-orange-500' : 'bg-orange-100 text-orange-700 border-orange-300 hover:bg-orange-200',
                        red: isSelected ? 'bg-red-500 text-white border-red-500' : 'bg-red-100 text-red-700 border-red-300 hover:bg-red-200',
                        pink: isSelected ? 'bg-pink-500 text-white border-pink-500' : 'bg-pink-100 text-pink-700 border-pink-300 hover:bg-pink-200',
                        yellow: isSelected ? 'bg-yellow-500 text-white border-yellow-500' : 'bg-yellow-100 text-yellow-700 border-yellow-300 hover:bg-yellow-200',
                        indigo: isSelected ? 'bg-indigo-500 text-white border-indigo-500' : 'bg-indigo-100 text-indigo-700 border-indigo-300 hover:bg-indigo-200',
                      };
                      const categoryColorClass = colorClasses[category.color as keyof typeof colorClasses] || colorClasses.blue;
                      
                      return (
                        <button
                          key={category.id}
                          onClick={() => handleCategoryFilter(category.id)}
                          className={`inline-flex items-center px-3 py-2 rounded-md text-sm font-medium border ${categoryColorClass}`}
                        >
                          {category.name}
                        </button>
                      );
                    })}
                  </div>
                </div>
                
                <div>
                  <label htmlFor="priority" className="block text-sm font-medium text-gray-700">Ïö∞ÏÑ†ÏàúÏúÑ</label>
                  <select
                    id="priority"
                    value={filters.priority || ''}
                    onChange={(e) => handlePriorityFilter(e.target.value as 'low' | 'medium' | 'high' | undefined || undefined)}
                    className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md"
                  >
                    <option value="">Ï†ÑÏ≤¥ Ïö∞ÏÑ†ÏàúÏúÑ</option>
                    <option value="high">üî¥ ÎÜíÏùå</option>
                    <option value="medium">üü° Î≥¥ÌÜµ</option>
                    <option value="low">üü¢ ÎÇÆÏùå</option>
                  </select>
                </div>

                <div>
                  <label htmlFor="dueDate" className="block text-sm font-medium text-gray-700">ÎßàÍ∞êÏùº</label>
                  <select
                    id="dueDate"
                    value={filters.dueDate || 'all'}
                    onChange={(e) => handleDueDateFilter(e.target.value as 'all' | 'overdue' | 'today' | 'tomorrow' | 'thisWeek' | 'thisMonth' | 'future' | 'noDueDate')}
                    className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md"
                  >
                    <option value="all">Ï†ÑÏ≤¥</option>
                    <option value="overdue">‚ö†Ô∏è ÏßÄÏó∞</option>
                    <option value="today">üìÖ Ïò§Îäò</option>
                    <option value="tomorrow">‚è∞ ÎÇ¥Ïùº</option>
                    <option value="thisWeek">üìä Ïù¥Î≤à Ï£º</option>
                    <option value="thisMonth">üìÜ Ïù¥Î≤à Îã¨</option>
                    <option value="future">üîÆ ÎØ∏Îûò</option>
                    <option value="noDueDate">‚ùå ÎßàÍ∞êÏùº ÏóÜÏùå</option>
                  </select>
                </div>
              </div>

              {/* ÌïÑÌÑ∞ ÌîÑÎ¶¨ÏÖã */}
              <div className="mt-6">
                <FilterPresets
                  currentFilters={filters}
                  onApplyPreset={handleFiltersChange}
                  categories={categories}
                />
              </div>
            </div>
          </div>
        </div>

      <TodoList
        todos={todos}
        categories={categories}
        editingId={editingId}
        searchTerm={filters.search}
        onToggle={toggleComplete}
        onDelete={deleteTodo}
        onEdit={handleEdit}
        onUpdate={updateTodo}
        onUpdatePriority={updatePriority}
        onCancelEdit={handleCancelEdit}
        getCategoryById={getCategoryById}
      />
      </div>
    </div>
  );
};